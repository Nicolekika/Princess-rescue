<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Princess Rescue ‚Äî Full (18+, Lofi)</title>
  <style>
  :root { --bg:#fff9fc; --ink:#3a2f35; --line:#f2d9e8; --panel:#ffffffcc; --pill:#f7e7f1; --cta:#f9dff0; --shadow:0 10px 30px rgba(125,89,110,.12); }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#ffeef7);font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink)}
  .topbar{position:sticky;top:0;background:rgba(255,255,255,.65);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:10px 12px;display:flex;justify-content:space-between;z-index:5}
  .brand{font-weight:800}
  .pill{background:var(--pill);border:1px solid var(--line);border-radius:999px;padding:8px 12px;cursor:pointer;box-shadow:var(--shadow)}
  .pill.small{padding:6px 10px;font-size:.9rem}
  .cta{background:var(--cta);border:none;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow);font-weight:700}
  .ghost{background:transparent;border:1px solid var(--line);border-radius:12px;padding:10px 14px;cursor:pointer}
  .wrap{max-width:1000px;margin:0 auto;padding:16px;position:relative}
  canvas{width:100%;height:auto;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);background:#fff0f6}
  .hud{position:absolute;top:16px;left:16px;display:flex;gap:10px;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:6px 10px;align-items:center}
  .stat{font-weight:700;color:#6b5b64}
  dialog::backdrop{background:rgba(0,0,0,.35)} dialog{border:none;border-radius:16px;padding:0}
  dialog .sheet{background:#fff;padding:16px;min-width:min(520px,92vw);border-radius:16px}
  .rescue .scene{height:160px;border:1px dashed var(--line);border-radius:12px;display:grid;place-items:center;background:linear-gradient(180deg,#fff,#ffeef7)}
  .rescue .princess{font-weight:800;color:#e06aa6;text-shadow:1px 1px #fff}
  .audio-bar{display:flex;gap:10px;justify-content:center;align-items:center;margin:14px 0 0}
  .tiny{opacity:.7;font-size:.9rem}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">‚ô° Princess Rescue</div>
    <nav>
      <button id="btn-how" class="pill">Hur spelar man?</button>
      <button id="btn-shop" class="pill">Butik</button>
    </nav>
  </header>

  <main class="wrap">
    <div class="game-wrap" style="position:relative">
      <canvas id="game" width="960" height="540"></canvas>
      <div class="hud">
        <div class="stat">‚ù§ <span id="lives">3</span></div>
        <div class="stat">‚òÖ <span id="hearts">0</span>/5</div>
        <div class="stat">‚è± <span id="time">0.0s</span></div>
      </div>
    </div>

    <!-- Ljudkontroll -->
    <div class="audio-bar">
      <button id="btn-audio" class="pill small" title="Ljud p√•/av">üîá Lofi</button>
      <span class="tiny">Klicka f√∂r att starta/pausa musiken</span>
    </div>

    <!-- MP3-filen m√•ste ligga i samma mapp som index.html -->
    <audio id="bgm" src="lofi.mp3" preload="auto" loop playsinline></audio>
  </main>

  <!-- Dialoger -->
  <dialog id="how"><form method="dialog" class="sheet">
    <h3>Hur spelar man</h3>
    <ul><li>A/D eller ‚Üê/‚Üí = g√•</li><li>W/‚Üë/Space = hoppa</li><li>Undvik hinder, samla 5 hj√§rtan, n√• prinsessan.</li></ul>
    <menu><button class="cta">OK</button></menu>
  </form></dialog>

  <dialog id="shop"><form method="dialog" class="sheet">
    <h3>Butik (demo)</h3>
    <p>Koppla betalning i produktion.</p>
    <menu><button class="ghost">St√§ng</button></menu>
  </form></dialog>

  <dialog id="rescue"><form method="dialog" class="sheet rescue">
    <div class="scene"><div class="princess">Thank you, hero!</div></div>
    <p>Du r√§ddade prinsessan üíñ</p>
    <menu><button class="ghost" id="btn-replay">Spela igen</button></menu>
  </form></dialog>

<script>
(() => {
  // ====== Canvas / 2D context ======
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // ====== HUD & dialoger ======
  const livesEl = document.getElementById('lives');
  const heartsEl = document.getElementById('hearts');
  const timeEl = document.getElementById('time');
  const dlgHow = document.getElementById('how');
  const dlgShop = document.getElementById('shop');
  const dlgRescue = document.getElementById('rescue');
  document.getElementById('btn-how').addEventListener('click',()=>dlgHow.showModal());
  document.getElementById('btn-shop').addEventListener('click',()=>dlgShop.showModal());
  document.getElementById('btn-replay')?.addEventListener('click',()=>{ dlgRescue.close(); reset(); });

  // ====== Ljud (MP3) ======
  const bgm = document.getElementById('bgm');
  const audioBtn = document.getElementById('btn-audio');
  let musicOn = false;
  if (bgm && audioBtn) {
    bgm.volume = 0.15;                 // l√•g sk√∂n volym
    audioBtn.textContent = 'üîá Lofi';  // b√∂rjar "muted"

    async function toggleAudio() {
      try {
        if (!musicOn) { await bgm.play(); musicOn = true; audioBtn.textContent = 'üéß Lofi'; }
        else          { bgm.pause();     musicOn = false; audioBtn.textContent = 'üîá Lofi'; }
      } catch (e) {
        alert('Om det √§r tyst: h√∂j volymen, sl√• av tyst l√§ge och klicka igen.');
      }
    }
    audioBtn.addEventListener('click', toggleAudio);
    // Safari/Chrome policy ‚Äì starta efter f√∂rsta tangenttryck
    document.body.addEventListener('keydown', async () => {
      if (!musicOn) { try { await bgm.play(); musicOn = true; audioBtn.textContent = 'üéß Lofi'; } catch {} }
    }, { once:true });
  }

  // ====== Input ======
  const keys = {};
  addEventListener('keydown', e => keys[e.key] = true);
  addEventListener('keyup',   e => keys[e.key] = false);

  // ====== Spel-tillst√•nd ======
  const sky='#ffe7f2', block='#ffe1ef', spike='#f6a0c1', heartC='#ff7aa2';
  let player, princess, platforms, movers, spikes, blobs, hearts, t0, got, lives, won;
  const GRAV=0.5, JUMP=10.2, SPEED=2.4, MAX_VY=16;

  function reset(){
    player={x:60,y:420,w:28,h:36,vx:0,vy:0,on:false,dir:1};
    princess={x:840,y:140,w:28,h:44};
    platforms=[[0,500,960,40],[160,440,120,16],[320,380,120,16],[520,320,120,16],[720,260,120,16],[780,180,140,16]];
    movers=[{x:240,y:480,w:100,h:16,dx:0,dy:-1.2,range:60,t:0},{x:610,y:360,w:90,h:16,dx:1.4,dy:0,range:80,t:0}];
    spikes=[[220,500,28],[248,500,28],[276,500,28],[420,500,28],[448,500,28],[476,500,28],[520,500,28],[548,500,28],[400,364,28],[580,308,28]];
    blobs=[{x:330,y:364,w:26,h:18,vx:1,minX:320,maxX:440},{x:740,y:244,w:26,h:18,vx:-1,minX:720,maxX:840}];
    hearts=[{x:185,y:400,t:false},{x:350,y:340,t:false},{x:550,y:280,t:false},{x:750,y:220,t:false},{x:880,y:150,t:false}];
    got=0; lives=3; won=false; t0=performance.now();
    livesEl.textContent=lives; heartsEl.textContent=got;
  }

  function overlap(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
  function triHit(px,py,ax,ay,bx,by,cx,cy){
    const v0x=cx-ax,v0y=cy-ay,v1x=bx-ax,v1y=by-ay,v2x=px-ax,v2y=py-ay;
    const d00=v0x*v0x+v0y*v0y,d01=v0x*v1x+v0y*v1y,d02=v0x*v2x+v0y*v2y,d11=v1x*v1x+v1y*v1y,d12=v1x*v2x+v1y*v2y;
    const inv=1/(d00*d11-d01*d01); const u=(d11*d02-d01*d12)*inv, v=(d00*d12-d01*d02)*inv; return (u>=0)&&(v>=0)&&((u+v)<1);
  }

  function update(dt){
    const left = keys['ArrowLeft']||keys['a']||keys['A'];
    const right= keys['ArrowRight']||keys['d']||keys['D'];
    const jump = keys['ArrowUp']||keys['w']||keys['W']||keys[' '];

    player.vx=0; if(left) player.vx=-SPEED,player.dir=-1; if(right) player.vx=SPEED,player.dir=1;
    player.vy+=GRAV; if(player.vy>MAX_VY) player.vy=MAX_VY;

    // X-kollision
    player.x+=player.vx;
    for(const p of platforms){ const r={x:p[0],y:p[1],w:p[2],h:p[3]}; if(overlap(player,r)){ if(player.vx>0) player.x=r.x-player.w; else if(player.vx<0) player.x=r.x+r.w; } }

    // Y-kollision
    player.y+=player.vy; player.on=false;
    for(const p of platforms){ const r={x:p[0],y:p[1],w:p[2],h:p[3]}; if(overlap(player,r)){ if(player.vy>0){player.y=r.y-player.h;player.vy=0;player.on=true;} else if(player.vy<0){player.y=r.y+r.h;player.vy=0;} } }

    // R√∂rliga plattformar
    for(const m of movers){
      m.t+=dt;
      const ox=Math.sin(m.t*0.001)*m.range*m.dx, oy=Math.sin(m.t*0.001)*m.range*m.dy;
      const r={x:m.x+ox,y:m.y+oy,w:m.w,h:m.h};
      if(overlap(player,r) && player.vy>=0){
        player.y=r.y-player.h; player.vy=0; player.on=true;
        player.x+=(m.dx!==0?Math.cos(m.t*0.001)*m.range*0.03*m.dx:0);
      }
    }

    if(jump && player.on){ player.vy=-JUMP; player.on=false; }

    // F√§llor/fiender
    for(const s of spikes){ const[sx,sy,size]=s; const px=player.x+player.w/2, py=player.y+player.h-2;
      if(triHit(px,py,sx,sy,sx+size,sy,sx+size/2,sy-size)){ die(); break; } }
    for(const b of blobs){ b.x+=b.vx; if(b.x<b.minX||b.x+b.w>b.maxX) b.vx*=-1; if(overlap(player,b)){ die(); break; } }

    // Hj√§rtan
    for(const h of hearts){ if(!h.t){ const dx=(player.x+player.w/2)-h.x, dy=(player.y+player.h/2)-h.y;
      if(Math.hypot(dx,dy)<20){ h.t=true; got++; heartsEl.textContent=got; } } }

    // Vinst
    const r={x:princess.x,y:princess.y,w:princess.w,h:princess.h};
    if(got>=5 && overlap(player,r)){ dlgRescue.showModal(); won=true; if(musicOn) bgm.pause(); }

    const t=(performance.now()-t0)/1000; timeEl.textContent=t.toFixed(1)+'s';
  }

  function die(){ livesEl.textContent=--lives; if(lives<=0) reset(); else { player.x=60; player.y=420; player.vx=0; player.vy=0; } }

  function draw(){
    ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);
    // lite moln
    ctx.fillStyle='#fff';
    for(let i=0;i<6;i++){ const x=(i*180)%W, y=60+((i%2)*30); ctx.globalAlpha=.25;
      ctx.beginPath(); ctx.arc(x,y,40,0,Math.PI*2); ctx.arc(x+40,y+10,28,0,Math.PI*2); ctx.arc(x+80,y,36,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
    // mark
    ctx.fillStyle='#d7f0ff'; ctx.fillRect(0,440,W,100);
    // plattformar
    ctx.fillStyle=block; for(const p of platforms) ctx.fillRect(p[0],p[1],p[2],p[3]);
    // movers
    for(const m of movers){ const ox=Math.sin(m.t*0.001)*m.range*m.dx, oy=Math.sin(m.t*0.001)*m.range*m.dy;
      ctx.fillStyle='#ffd6ec'; ctx.fillRect(m.x+ox,m.y+oy,m.w,m.h); }
    // spikes
    ctx.fillStyle=spike; for(const s of spikes){ const [x,y,size]=s; ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+size,y); ctx.lineTo(x+size/2,y-size); ctx.closePath(); ctx.fill(); }
    // blobs
    ctx.fillStyle='#c6a3ff'; for(const b of blobs) ctx.fillRect(b.x,b.y,b.w,b.h);
    // hj√§rtan
    for(const h of hearts){ if(h.t) continue; ctx.fillStyle=heartC;
      ctx.fillRect(h.x-2,h.y,4,4); ctx.fillRect(h.x-4,h.y+2,8,4); ctx.fillRect(h.x-6,h.y+4,12,4); ctx.fillRect(h.x-4,h.y+8,8,4); ctx.fillRect(h.x-2,h.y+10,4,4); }
    // prinsessan + spelare
    ctx.fillStyle='#ffb3c7'; ctx.fillRect(princess.x,princess.y,princess.w,princess.h);
    ctx.fillStyle='#222';    ctx.fillRect(player.x,player.y,player.w,player.h);
  }

  // Loop
  let last = performance.now();
  let won = false;
  function loop(t){ const dt = t-last; last=t; if(!won) update(dt); draw(); requestAnimationFrame(loop); }

  // Start
  let lives = 3;
  function initActors(){
    blobs=[{x:330,y:364,w:26,h:18,vx:1,minX:320,maxX:440},{x:740,y:244,w:26,h:18,vx:-1,minX:720,maxX:840}];
    hearts=[{x:185,y:400,t:false},{x:350,y:340,t:false},{x:550,y:280,t:false},{x:750,y:220,t:false},{x:880,y:150,t:false}];
  }
  initActors(); reset(); requestAnimationFrame(loop);
})();
</script>
</body>
</html>
