<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Princess Rescue ‚Äî Full (18+, Super Soft Lofi)</title>
  <style>
  :root { --bg:#fff9fc; --ink:#3a2f35; --line:#f2d9e8; --panel:#ffffffcc; --pill:#f7e7f1; --cta:#f9dff0; --shadow:0 10px 30px rgba(125,89,110,.12); }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#ffeef7);font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink)}
  .topbar{position:sticky;top:0;background:rgba(255,255,255,.65);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:10px 12px;display:flex;justify-content:space-between;z-index:5}
  .brand{font-weight:800}
  .pill{background:var(--pill);border:1px solid var(--line);border-radius:999px;padding:8px 12px;cursor:pointer;box-shadow:var(--shadow)}
  .pill.small{padding:6px 10px;font-size:.9rem}
  .cta{background:var(--cta);border:none;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow);font-weight:700}
  .ghost{background:transparent;border:1px solid var(--line);border-radius:12px;padding:10px 14px;cursor:pointer}
  .wrap{max-width:1000px;margin:0 auto;padding:16px;position:relative}
  canvas{width:100%;height:auto;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);background:#fff0f6}
  .hud{position:absolute;top:16px;left:16px;display:flex;gap:10px;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:6px 10px;align-items:center}
  .stat{font-weight:700;color:#6b5b64}
  dialog::backdrop{background:rgba(0,0,0,.35)} dialog{border:none;border-radius:16px;padding:0}
  dialog .sheet{background:#fff;padding:16px;min-width:min(520px,92vw);border-radius:16px}
  dialog .sheet.center{text-align:center}
  .rescue .scene{height:160px;border:1px dashed var(--line);border-radius:12px;display:grid;place-items:center;background:linear-gradient(180deg,#fff,#ffeef7)}
  .rescue .princess{font-weight:800;color:#e06aa6;text-shadow:1px 1px #fff}
  .touch{position:absolute;left:0;right:0;bottom:12px;display:flex;justify-content:space-between;align-items:flex-end;padding:0 14px;gap:12px;pointer-events:none}
  .tbtn{pointer-events:auto;border:none;border-radius:16px;background:rgba(255,255,255,.5);backdrop-filter:blur(6px);width:74px;height:74px;font-size:28px;box-shadow:var(--shadow)}
  .tbtn.jump{width:86px;height:86px}
  @media(min-width:900px){.touch{display:none}}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">‚ô° Princess Rescue</div>
    <nav>
      <button id="btn-how" class="pill">Hur spelar man?</button>
      <button id="btn-shop" class="pill">Butik</button>
    </nav>
  </header>

  <main class="wrap">
    <div class="game-wrap" style="position:relative">
      <canvas id="game" width="960" height="540"></canvas>
      <div class="hud">
        <div class="stat">‚ù§ <span id="lives">3</span></div>
        <div class="stat">‚òÖ <span id="hearts">0</span>/5</div>
        <div class="stat">‚è± <span id="time">0.0s</span></div>
        <button id="btn-audio" class="pill small" title="Ljud p√•/av">üîá Lofi</button>
      </div>
      <div class="touch">
        <button class="tbtn" id="btn-left">‚óÄ</button>
        <button class="tbtn" id="btn-right">‚ñ∂</button>
        <button class="tbtn jump" id="btn-jump">‚§í</button>
      </div>
    </div>
  </main>

  <dialog id="ageGate">
    <form method="dialog" class="sheet">
      <h2>Bekr√§fta √•lder</h2>
      <p>Detta √§r ett vuxet utrymme (icke-explicit spel). Du m√•ste vara 18+.</p>
      <label class="check"><input type="checkbox" id="confirm18" required> Jag √§r 18+</label>
      <menu><button class="ghost" value="cancel">Avbryt</button><button class="cta" value="ok" id="enter">Forts√§tt</button></menu>
    </form>
  </dialog>

  <dialog id="how">
    <form method="dialog" class="sheet">
      <h3>Hur spelar man</h3>
      <ul><li>A/D eller ‚Üê/‚Üí = g√•</li><li>W/‚Üë/Space = hoppa</li><li>Mobil: touchknapparna</li></ul>
      <menu><button class="cta">OK</button></menu>
    </form>
  </dialog>

  <dialog id="shop">
    <form method="dialog" class="sheet">
      <h3>Butik (demo)</h3>
      <p>Koppla betalning i produktion.</p>
      <button class="pill" id="btn-membership">K√∂p medlemskap</button>
      <menu><button class="ghost">St√§ng</button></menu>
    </form>
  </dialog>

  <dialog id="rescue">
    <form method="dialog" class="sheet rescue">
      <div class="scene"><div class="princess">Thank you, hero!</div></div>
      <p>Du r√§ddade prinsessan üíñ</p>
      <menu><button class="ghost" id="btn-replay">Spela igen</button></menu>
    </form>
  </dialog>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const livesEl = document.getElementById('lives');
  const heartsEl = document.getElementById('hearts');
  const timeEl = document.getElementById('time');
  const dlgAge = document.getElementById('ageGate');
  const dlgHow = document.getElementById('how');
  const dlgShop = document.getElementById('shop');
  const dlgRescue = document.getElementById('rescue');
  const audioBtn = document.getElementById('btn-audio');
  const tLeft = document.getElementById('btn-left');
  const tRight = document.getElementById('btn-right');
  const tJump = document.getElementById('btn-jump');
  const confirm18 = document.getElementById('confirm18');
  const enter = document.getElementById('enter');

  // Age gate
  if(localStorage.getItem('age_ok')!=='yes'){ setTimeout(()=>dlgAge.showModal(),30); }
  enter?.addEventListener('click',(e)=>{ if(!confirm18.checked){ e.preventDefault(); alert('Bekr√§fta 18+.'); } else localStorage.setItem('age_ok','yes'); });

  // Input
  const keys={}; addEventListener('keydown',e=>keys[e.key]=true); addEventListener('keyup',e=>keys[e.key]=false);
  let leftHeld=false,rightHeld=false,jumpHeld=false;
  function bind(btn,down,up){ if(!btn) return; const d=(e)=>{e.preventDefault();down();}; const u=(e)=>{e.preventDefault();up();}; btn.addEventListener('touchstart',d);btn.addEventListener('mousedown',d);btn.addEventListener('touchend',u);btn.addEventListener('mouseup',u);btn.addEventListener('mouseleave',u);}
  bind(tLeft,()=>leftHeld=true,()=>leftHeld=false);
  bind(tRight,()=>rightHeld=true,()=>rightHeld=false);
  bind(tJump,()=>jumpHeld=true,()=>jumpHeld=false);

  // Super soft lofi chords (no hats), OFF by default
  let ac, musicOn=false, seqTimer;
  function initAudio(){ if(ac) return; ac=new (window.AudioContext||window.webkitAudioContext)(); }
  function envGain(time, dur, a=0.08, r=0.7, peak=0.035){
    const g = ac.createGain();
    g.gain.setValueAtTime(0, time);
    g.gain.linearRampToValueAtTime(peak, time+a);
    g.gain.linearRampToValueAtTime(peak, time+Math.max(0,dur-r));
    g.gain.linearRampToValueAtTime(0.0001, time+dur);
    return g;
  }
  function tone(freq=200, dur=1.4){ if(!ac) return;
    const o = ac.createOscillator(); o.type='sine'; o.frequency.value=freq*0.95;
    const g = envGain(ac.currentTime, dur, 0.10, 0.8, 0.028);
    const lpf = ac.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=650;
    o.connect(g); g.connect(lpf); lpf.connect(ac.destination);
    o.start(); o.stop(ac.currentTime+dur);
  }
  function startMusic(){
    if(!ac) initAudio(); if(!musicOn) return; stopMusic();
    // ~60 BPM, mjuka treklanger
    let i=0; const prog=[[261,311,392],[233,293,370],[220,277,349],[233,293,370]];
    seqTimer=setInterval(()=>{ const ch=prog[i%prog.length]; ch.forEach(f=>tone(f,1.6)); i++; }, 1000);
  }
  function stopMusic(){ clearInterval(seqTimer); seqTimer=null; }
  audioBtn.textContent='üîá Lofi';
  audioBtn.addEventListener('click',()=>{
    if(!ac) initAudio();
    musicOn=!musicOn;
    audioBtn.textContent = musicOn ? 'üéß Lofi' : 'üîá Lofi';
    musicOn ? startMusic() : stopMusic();
  });
  document.body.addEventListener('keydown',()=>{ if(!ac) initAudio(); },{once:true});

  // Game state
  const sky='#ffe7f2', block='#ffe1ef', spike='#f6a0c1', heartC='#ff7aa2';
  let player, princess, platforms, movers, spikes, blobs, hearts, t0, got, lives, won;
  const GRAV=0.5,JUMP=10.2,SPEED=2.4,MAX_VY=16;

  function reset(){
    player={x:60,y:420,w:28,h:36,vx:0,vy:0,on:false,dir:1};
    princess={x:840,y:140,w:28,h:44};
    platforms=[[0,500,960,40],[160,440,120,16],[320,380,120,16],[520,320,120,16],[720,260,120,16],[780,180,140,16]];
    movers=[{x:240,y:480,w:100,h:16,dx:0,dy:-1.2,range:60,t:0},{x:610,y:360,w:90,h:16,dx:1.4,dy:0,range:80,t:0}];
    spikes=[[220,500,28],[248,500,28],[276,500,28],[420,500,28],[448,500,28],[476,500,28],[520,500,28],[548,500,28],[400,364,28],[580,308,28]];
    blobs=[{x:330,y:364,w:26,h:18,vx:1,minX:320,maxX:440},{x:740,y:244,w:26,h:18,vx:-1,minX:720,maxX:840}];
    hearts=[{x:185,y:400,t:false},{x:350,y:340,t:false},{x:550,y:280,t:false},{x:750,y:220,t:false},{x:880,y:150,t:false}];
    got=0; lives=3; won=false; t0=performance.now();
    livesEl.textContent=lives; heartsEl.textContent=got;
  }
  function overlap(a,b){return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;}
  function triHit(px,py,ax,ay,bx,by,cx,cy){const v0x=cx-ax,v0y=cy-ay,v1x=bx-ax,v1y=by-ay,v2x=px-ax,v2y=py-ay;const d00=v0x*v0x+v0y*v0y,d01=v0x*v1x+v0y*v1y,d02=v0x*v2x+v0y*v2y,d11=v1x*v1x+v1y*v1y,d12=v1x*v2x+v1y*v2y;const inv=1/(d00*d11-d01*d01);const u=(d11*d02-d01*d12)*inv,v=(d00*d12-d01*d02)*inv;return(u>=0)&&(v>=0)&&((u+v)<1);}

  function update(dt){
    const left=keys['ArrowLeft']||keys['a']||keys['A']||leftHeld;
    const right=keys['ArrowRight']||keys['d']||keys['D']||rightHeld;
    const jump=keys['ArrowUp']||keys['w']||keys['W']||keys[' ']||jumpHeld;
    player.vx=0; if(left) player.vx=-SPEED,player.dir=-1; if(right) player.vx=SPEED,player.dir=1;
    player.vy+=GRAV; if(player.vy>MAX_VY) player.vy=MAX_VY;
    player.x+=player.vx;
    for(const p of platforms){const r={x:p[0],y:p[1],w:p[2],h:p[3]}; if(overlap(player,r)){ if(player.vx>0) player.x=r.x-player.w; else if(player.vx<0) player.x=r.x+r.w; }}
    player.y+=player.vy; player.on=false;
    for(const p of platforms){const r={x:p[0],y:p[1],w:p[2],h:p[3]}; if(overlap(player,r)){ if(player.vy>0){player.y=r.y-player.h;player.vy=0;player.on=true;} else if(player.vy<0){player.y=r.y+r.h;player.vy=0;} }}
    for(const m of movers){m.t+=dt;const ox=Math.sin(m.t*0.001)*m.range*m.dx,oy=Math.sin(m.t*0.001)*m.range*m.dy;const r={x:m.x+ox,y:m.y+oy,w:m.w,h:m.h}; if(overlap(player,r)&&player.vy>=0){player.y=r.y-player.h;player.vy=0;player.on=true;player.x+=(m.dx!==0?Math.cos(m.t*0.001)*m.range*0.03*m.dx:0);}}
    if(jump && player.on){player.vy=-JUMP; player.on=false;}

    for(const s of spikes){const[sx,sy,size]=s;const px=player.x+player.w/2,py=player.y+player.h-2; if(triHit(px,py,sx,sy,sx+size,sy,sx+size/2,sy-size)){die();break;}}
    for(const b of blobs){b.x+=b.vx; if(b.x<b.minX||b.x+b.w>b.maxX) b.vx*=-1; if(overlap(player,b)){die();break;}}
    for(const h of hearts){if(!h.t){const dx=(player.x+player.w/2)-h.x,dy=(player.y+player.h/2)-h.y; if(Math.hypot(dx,dy)<20){h.t=true;got++;heartsEl.textContent=got; }}}
    const r={x:princess.x,y:princess.y,w:princess.w,h:princess.h}; if(got>=5 && overlap(player,r)){ dlgRescue.showModal(); won=true; stopMusic(); }
    const t=(performance.now()-t0)/1000; timeEl.textContent=t.toFixed(1)+'s';
  }
  function die(){ livesEl.textContent=--lives; if(lives<=0) reset(); else {player.x=60;player.y=420;player.vx=0;player.vy=0;} }

  function draw(){
    ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='#fff'; for(let i=0;i<6;i++){ const x=(i*180)%W; const y=60+((i%2)*30); ctx.globalAlpha=0.25; ctx.beginPath(); ctx.arc(x,y,40,0,Math.PI*2); ctx.arc(x+40,y+10,28,0,Math.PI*2); ctx.arc(x+80,y,36,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
    ctx.fillStyle='#d7f0ff'; ctx.fillRect(0, 440, W, 100);
    ctx.fillStyle=block; for(const p of platforms) ctx.fillRect(p[0],p[1],p[2],p[3]);
    for(const m of movers){const ox=Math.sin(m.t*0.001)*m.range*m.dx,oy=Math.sin(m.t*0.001)*m.range*m.dy; ctx.fillStyle='#ffd6ec'; ctx.fillRect(m.x+ox,m.y+oy,m.w,m.h);}
    ctx.fillStyle=spike; for(const s of spikes){const[x,y,size]=s; ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+size,y); ctx.lineTo(x+size/2,y-size); ctx.closePath(); ctx.fill();}
    ctx.fillStyle='#c6a3ff'; for(const b of blobs) ctx.fillRect(b.x,b.y,b.w,b.h);
    for(const h of hearts){ if(h.t) continue; ctx.fillStyle=heartC; ctx.fillRect(h.x-2,h.y,4,4); ctx.fillRect(h.x-4,h.y+2,8,4); ctx.fillRect(h.x-6,h.y+4,12,4); ctx.fillRect(h.x-4,h.y+8,8,4); ctx.fillRect(h.x-2,h.y+10,4,4); }
    ctx.fillStyle='#ffb3c7'; ctx.fillRect(princess.x,princess.y,princess.w,princess.h);
    ctx.fillStyle='#222'; ctx.fillRect(player.x,player.y,player.w,player.h);
  }

  let last=performance.now(); won=false;
  function loop(t){ const dt=t-last; last=t; if(!won) update(dt); draw(); requestAnimationFrame(loop); }
  reset(); requestAnimationFrame(loop);
})();
</script>
</body>
</html>
