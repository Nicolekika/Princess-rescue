<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Princess Rescue ‚Äî Soft Zelda Lofi (Single File)</title>
<style>
:root{
  --bg:#fff9fc;--ink:#372d36;--line:#efd6ea;--panel:#ffffffbf;--pill:#f7e7f1;--cta:#f9dff0;
  --shadow:0 10px 30px rgba(125,89,110,.12);
  --sky1:#ffeaf5;--sky2:#fff;--ground:#e9f5ff;--plat:#ffe1ef;--accent:#ff8db0;--vio:#c8b3ff;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,var(--sky2),var(--sky1));
  font-family:ui-rounded,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink)}
.topbar{position:sticky;top:0;z-index:10;background:#ffffffb3;backdrop-filter:blur(8px);
  border-bottom:1px solid var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between}
.brand{font-weight:900;letter-spacing:.2px}
.pill{background:var(--pill);border:1px solid var(--line);border-radius:999px;padding:8px 12px;cursor:pointer;box-shadow:var(--shadow)}
.pill.small{padding:6px 10px;font-size:.9rem}
.wrap{max-width:1000px;margin:0 auto;padding:16px}
.stage{position:relative}
canvas{width:100%;height:auto;background:transparent;border:1px solid var(--line);
  border-radius:14px;box-shadow:var(--shadow)}
.hud{position:absolute;top:16px;left:16px;display:flex;gap:10px;background:var(--panel);
  border:1px solid var(--line);border-radius:12px;padding:6px 10px;align-items:center}
.stat{font-weight:800;color:#6c5c67}
.audio{display:flex;gap:10px;align-items:center;justify-content:center;margin:12px 0 0}
.tiny{opacity:.7;font-size:.9rem}
dialog::backdrop{background:rgba(0,0,0,.35)}
dialog{border:none;border-radius:16px;padding:0}
.sheet{background:#fff;border-radius:16px;min-width:min(520px,92vw);padding:16px}
.help ul{margin:.4rem 0 0 1.1rem}
.badge{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 8px;background:#fff}
</style>
</head>
<body>
<header class="topbar">
  <div class="brand">‚ô° Princess Rescue</div>
  <div style="display:flex;gap:8px">
    <button id="btn-how" class="pill">Hur spelar man?</button>
    <button id="btn-music" class="pill small" title="Starta/pausa musik">üîá Lofi</button>
  </div>
</header>

<main class="wrap">
  <div class="stage">
    <canvas id="game" width="960" height="540" aria-label="Spelduk"></canvas>
    <div class="hud">
      <div class="stat">‚ù§ <span id="lives">3</span></div>
      <div class="stat">‚òÖ <span id="hearts">0</span>/5</div>
      <div class="stat">‚è± <span id="time">0.0s</span></div>
      <span class="badge">A/D/‚Üê/‚Üí g√• ‚Ä¢ W/‚Üë/Space hoppa</span>
    </div>
  </div>
  <div class="audio">
    <span class="tiny">Musik: gullig/mjuk ‚ÄúZelda‚Äëlofi‚Äù (genererad lokalt)</span>
  </div>
</main>

<dialog id="dlgHow"><form method="dialog" class="sheet help">
  <h3>Hur spelar man</h3>
  <ul>
    <li>A/D eller ‚Üê/‚Üí f√∂r att g√•</li>
    <li>W/‚Üë/Space f√∂r att hoppa</li>
    <li>Undvik spikar & blobbar, samla 5 hj√§rtan och n√• prinsessan</li>
  </ul>
  <menu><button class="pill">OK</button></menu>
</form></dialog>

<dialog id="dlgWin"><form method="dialog" class="sheet">
  <h3>Du r√§ddade prinsessan üíñ</h3>
  <p>Tid: <b id="winTime">0.0s</b> ‚Ä¢ Hj√§rtan: <b>5/5</b></p>
  <menu><button id="btn-replay" class="pill">Spela igen</button></menu>
</form></dialog>

<script>
(() => {
  // ---------- Canvas & HUD ----------
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const livesEl  = document.getElementById('lives');
  const heartsEl = document.getElementById('hearts');
  const timeEl   = document.getElementById('time');
  const dlgHow   = document.getElementById('dlgHow');
  const dlgWin   = document.getElementById('dlgWin');
  const winTimeEl = document.getElementById('winTime');
  document.getElementById('btn-how').addEventListener('click',()=>dlgHow.showModal());
  document.getElementById('btn-replay').addEventListener('click',()=>{ dlgWin.close(); reset(); });

  // ---------- Cute sprites (pixel-ish) ----------
  function drawHero(x,y,dir) {
    // liten svart kropp + √∂ron/keps; accent p√• br√∂st
    ctx.fillStyle = '#222'; ctx.fillRect(x, y, 16, 18);                    // kropp
    ctx.fillStyle = '#333'; ctx.fillRect(x+2, y-2, 5, 2); ctx.fillRect(x+9, y-2, 5, 2); // "√∂ron"
    ctx.fillStyle = '#ffb6cc'; ctx.fillRect(x+6, y+6, 4, 4);               // hj√§rtdetalj
    // √∂gon (peka √•t dir)
    ctx.fillStyle = '#fff';
    if (dir>=0){ ctx.fillRect(x+11,y+6,2,2); ctx.fillRect(x+13,y+6,2,2); }
    else       { ctx.fillRect(x+1,y+6,2,2);  ctx.fillRect(x+3,y+6,2,2); }
  }
  function drawPrincess(x,y){
    ctx.fillStyle='#ffb3c7'; ctx.fillRect(x, y+8, 16, 14); // kl√§nning
    ctx.fillStyle='#ffd6e6'; ctx.fillRect(x+2, y, 12, 10); // √∂verdel
    ctx.fillStyle='#f7c7ff'; ctx.fillRect(x+4, y-4, 8, 4); // liten krona/diadem
    ctx.fillStyle='#fff'; ctx.fillRect(x+4,y+4,2,2); ctx.fillRect(x+10,y+4,2,2);
  }
  function drawBlob(b){ ctx.fillStyle='#c6a3ff'; ctx.fillRect(b.x, b.y, b.w, b.h); }
  function drawHeart(h){
    if (h.taken) return;
    const x=h.x,y=h.y; ctx.fillStyle='#ff7aa2';
    ctx.fillRect(x-2,y,4,4);ctx.fillRect(x-4,y+2,8,4);ctx.fillRect(x-6,y+4,12,4);
    ctx.fillRect(x-4,y+8,8,4);ctx.fillRect(x-2,y+10,4,4);
  }
  function drawSpike(x,y,s){
    ctx.fillStyle='#f6a0c1';
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+s,y); ctx.lineTo(x+s/2,y-s); ctx.closePath(); ctx.fill();
  }

  // ---------- Input ----------
  const keys = {};
  addEventListener('keydown', e=>keys[e.key]=true);
  addEventListener('keyup',   e=>keys[e.key]=false);

  // ---------- World ----------
  const SKY1 = '#fff', SKY2 = '#ffeaf5', GROUND='#eaf4ff', PLAT='#ffe1ef';
  let player, princess, platforms, movers, spikes, blobs, hearts, lives, got, t0, hasWon=false, lastT=performance.now();

  // physics constants
  const GRAV=0.5, SPEED=2.4, JUMP=10.2, MAX_VY=16;

  function reset(){
    player   = {x:70,y:420,w:16,h:18,vx:0,vy:0,on:false,dir:1};
    princess = {x:860,y:146,w:16,h:24};
    platforms=[
      [0,500,960,40],[160,440,120,16],[320,380,120,16],[520,320,120,16],[720,260,120,16],[780,186,140,12]
    ];
    movers=[
      {x:260,y:480,w:100,h:12,dx:0,dy:-1.1,range:60,t:0},
      {x:610,y:360,w:90,h:12,dx:1.4,dy:0,range:80,t:0}
    ];
    spikes=[[220,500,28],[248,500,28],[276,500,28],[420,500,28],[448,500,28],[476,500,28],
            [520,500,28],[548,500,28],[400,364,28],[580,308,28]];
    blobs=[{x:330,y:364,w:22,h:14,vx:1,minX:320,maxX:440},{x:740,y:244,w:22,h:14,vx:-1,minX:720,maxX:840}];
    hearts=[{x:185,y:400,taken:false},{x:350,y:340,taken:false},{x:550,y:280,taken:false},
            {x:750,y:220,taken:false},{x:880,y:160,taken:false}];
    lives=3; got=0; hasWon=false; t0=performance.now();
    livesEl.textContent=lives; heartsEl.textContent=got;
  }

  // helpers
  function overlap(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
  function triHit(px,py,ax,ay,bx,by,cx,cy){
    const v0x=cx-ax,v0y=cy-ay,v1x=bx-ax,v1y=by-ay,v2x=px-ax,v2y=py-ay;
    const d00=v0x*v0x+v0y*v0y,d01=v0x*v1x+v0y*v1y,d02=v0x*v2x+v0y*v2y,d11=v1x*v1x+v1y*v1y,d12=v1x*v2x+v1y*v2y;
    const inv=1/(d00*d11-d01*d01);const u=(d11*d02-d01*d12)*inv,v=(d00*d12-d01*d02)*inv; return u>=0&&v>=0&&(u+v)<1;
  }

  function die(){
    if(--lives<=0){ reset(); return; }
    livesEl.textContent=lives;
    // respawn
    player.x=70; player.y=420; player.vx=0; player.vy=0; player.on=false;
  }

  function update(dt){
    // movement
    const left = keys['ArrowLeft']||keys['a']||keys['A'];
    const right= keys['ArrowRight']||keys['d']||keys['D'];
    const jump = keys['ArrowUp']||keys['w']||keys['W']||keys[' '];
    player.vx=0; if(left)  {player.vx=-SPEED; player.dir=-1;}
                 if(right) {player.vx= SPEED; player.dir= 1;}
    player.vy+=GRAV; if(player.vy>MAX_VY) player.vy=MAX_VY;

    // horizontal
    player.x+=player.vx;
    for(const p of platforms){const r={x:p[0],y:p[1],w:p[2],h:p[3]};
      if(overlap(player,r)){ if(player.vx>0) player.x=r.x-player.w; else if(player.vx<0) player.x=r.x+r.w; } }

    // vertical
    player.y+=player.vy; player.on=false;
    for(const p of platforms){const r={x:p[0],y:p[1],w:p[2],h:p[3]};
      if(overlap(player,r)){
        if(player.vy>0){ player.y=r.y-player.h; player.vy=0; player.on=true; }
        else if(player.vy<0){ player.y=r.y+r.h; player.vy=0; }
      }
    }
    // movers (r√∂rliga plattformar)
    for(const m of movers){
      m.t+=dt;
      const ox=Math.sin(m.t*0.001)*m.range*m.dx, oy=Math.sin(m.t*0.001)*m.range*m.dy;
      const r={x:m.x+ox,y:m.y+oy,w:m.w,h:m.h};
      if(overlap(player,r) && player.vy>=0){
        player.y=r.y-player.h; player.vy=0; player.on=true;
        player.x += (m.dx!==0? Math.cos(m.t*0.001)*m.range*0.03*m.dx : 0); // lite med√•kning
      }
    }

    if(jump && player.on){ player.vy=-JUMP; player.on=false; }

    // farligt / fiender
    for(const s of spikes){
      const [sx,sy,sz]=s, px=player.x+player.w/2, py=player.y+player.h-2;
      if(triHit(px,py,sx,sy,sx+sz,sy,sx+sz/2,sy-sz)) { die(); break; }
    }
    for(const b of blobs){
      b.x+=b.vx; if(b.x<b.minX||b.x+b.w>b.maxX) b.vx*=-1;
      if(overlap(player,b)){ die(); break; }
    }

    // collect
    for(const h of hearts){
      if(!h.taken){
        const dx=player.x+player.w/2 - h.x, dy=player.y+player.h/2 - h.y;
        if(Math.hypot(dx,dy)<20){ h.taken=true; got++; heartsEl.textContent=got; }
      }
    }

    // win?
    const rP={x:princess.x,y:princess.y,w:princess.w,h:princess.h};
    if(got>=5 && overlap(player,rP)){
      hasWon=true; winTimeEl.textContent=timeEl.textContent; dlgWin.showModal();
    }

    // timer
    const t=(performance.now()-t0)/1000; timeEl.textContent=t.toFixed(1)+'s';
  }

  function draw(){
    // sky with soft clouds
    ctx.clearRect(0,0,W,H);
    const grad=ctx.createLinearGradient(0,0,0,H); grad.addColorStop(0,SKY2); grad.addColorStop(1,SKY1);
    ctx.fillStyle=grad; ctx.fillRect(0,0,W,H);
    ctx.globalAlpha=.25; ctx.fillStyle='#fff';
    for(let i=0;i<6;i++){ const x=(i*180)%W, y=60+((i%2)*28);
      ctx.beginPath(); ctx.arc(x,y,40,0,Math.PI*2);
      ctx.arc(x+40,y+10,28,0,Math.PI*2); ctx.arc(x+80,y,36,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=1;

    // ground
    ctx.fillStyle=GROUND; ctx.fillRect(0,440,W,100);

    // platforms
    ctx.fillStyle=PLAT; for(const p of platforms) ctx.fillRect(p[0],p[1],p[2],p[3]);

    // movers
    for(const m of movers){
      const ox=Math.sin(m.t*0.001)*m.range*m.dx, oy=Math.sin(m.t*0.001)*m.range*m.dy;
      ctx.fillStyle='#ffd6ec'; ctx.fillRect(m.x+ox,m.y+oy,m.w,m.h);
    }

    // spikes
    for(const s of spikes) drawSpike(s[0],s[1],s[2]);

    // blobs
    for(const b of blobs) drawBlob(b);

    // hearts
    for(const h of hearts) drawHeart(h);

    // princess & hero
    drawPrincess(princess.x, princess.y-24);
    drawHero(player.x, player.y, player.dir);
  }

  function loop(t){
    const dt = t - lastT; lastT = t;
    if(!hasWon) update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  reset(); requestAnimationFrame(loop);

  // ---------- Soft Zelda‚Äëlofi Music (WebAudio, no files) ----------
  const musicBtn = document.getElementById('btn-music');
  let ac=null, master=null, delay=null, lp=null, musicOn=false, stopAll=()=>{};
  function initAudio(){
    if(ac) return;
    ac = new (window.AudioContext||window.webkitAudioContext)();
    master = ac.createGain(); master.gain.value = 0.18; // l√•g mysvolym
    delay = ac.createDelay(0.6); delay.delayTime.value = 0.25; // litet eko
    const fb = ac.createGain(); fb.gain.value = 0.25;
    lp = ac.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value = 4200;
    master.connect(delay); delay.connect(fb); fb.connect(delay); delay.connect(lp); lp.connect(ac.destination);
  }
  function note(freq, t, dur=0.3, type='triangle', vol=0.35){
    const o=ac.createOscillator(), g=ac.createGain();
    o.type=type; o.frequency.setValueAtTime(freq, t);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.linearRampToValueAtTime(vol, t+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.connect(g); g.connect(master); o.start(t); o.stop(t+dur+0.05);
  }
  function chord(freqs, t, dur=0.9){ freqs.forEach(f=>note(f, t, dur, 'sine', 0.25)); }
  function arpeggio(freqs, t, step=0.14, vol=0.22){
    freqs.forEach((f,i)=>note(f, t+i*step, 0.22, 'triangle', vol));
  }
  function startMusic(){
    initAudio();
    const bpm=86, bar=60/bpm*4; // mjukt tempo
    let start=ac.currentTime+0.02;
    const root=261.63; // C
    const scale = [1, 9/8, 5/4, 4/3, 3/2, 5/3, 15/8]; // enkel jonisk skala
    const toF = (degree, oct=0)=> root*scale[(degree-1)%7]*Math.pow(2, Math.floor((degree-1)/7)+oct);
    const prog = [
      [toF(1),toF(3),toF(5),toF(7)],   // Cmaj7
      [toF(6,0),toF(1,1),toF(3,1)],    // Am7
      [toF(2,0),toF(4,0),toF(6,0)],    // Dm7
      [toF(5,0),toF(7,0),toF(2,1)]     // G
    ];
    // schedule loop 8 bars
    let alive=true;
    function scheduleLoop(cycleStart){
      for(let barIdx=0; barIdx<8; barIdx++){
        const t = cycleStart + barIdx*bar;
        const ch = prog[barIdx%prog.length];
        chord(ch, t, bar*0.9);
        // baseline (mjukt "plock")
        arpeggio([ch[0]/2,ch[0],ch[1]], t, 0.18, 0.18);
        // enkel melodi
        const m = [toF(3,1),toF(5,1),toF(4,1),toF(3,1),toF(5,1),toF(6,1),toF(5,1),toF(3,1)];
        note(m[(barIdx*2)%m.length], t+0.30, 0.25, 'triangle', 0.22);
        note(m[(barIdx*2+1)%m.length], t+0.75, 0.25, 'triangle', 0.22);
      }
      // resched
      if(alive){
        const next = cycleStart + 8*bar;
        stopAll = ()=>{ alive=false; };
        setTimeout(()=>alive && scheduleLoop(next), (8*bar-0.2)*1000);
      }
    }
    master.connect(ac.destination); // also dry a hair (goes through delay via master chain)
    scheduleLoop(start);
  }
  function toggleMusic(){
    try{
      if(!ac || ac.state==='suspended'){ initAudio(); ac.resume && ac.resume(); }
      if(!musicOn){ startMusic(); musicOn=true; musicBtn.textContent='üéß Lofi'; }
      else{ stopAll(); musicOn=false; musicBtn.textContent='üîá Lofi'; }
    }catch(e){ alert('Klicka igen om det √§r tyst, och h√∂j volymen.'); }
  }
  document.getElementById('btn-music').addEventListener('click', toggleMusic);
  // s√§kerhets‚Äëautostart efter f√∂rsta tangenttryck
  document.body.addEventListener('keydown', ()=>{ if(!musicOn){ toggleMusic(); } }, {once:true});
})();
</script>
</body>
</html>
